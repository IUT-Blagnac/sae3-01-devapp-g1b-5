CREATE OR REPLACE TRIGGER MAJ_QTE_BONBON
FOR INSERT OR UPDATE OR DELETE ON CONTIENTBONBON COMPOUND TRIGGER

TYPE type_enreg_emp IS RECORD (
    IDB BONBONS.IDB%TYPE,
    QUANTITEKG CONTIENTBONBON.QUANTITEKG%TYPE,
    IDPANIER CONTIENTBONBON.IDPANIER%TYPE
);

TYPE typeTab_enreg_emp IS TABLE OF type_enreg_emp INDEX BY PLS_INTEGER;

monTab_Emp typeTab_enreg_emp;

AFTER EACH ROW IS
BEGIN
    monTab_Emp(monTab_Emp.COUNT + 1).IDB := :NEW.IDB;
    monTab_Emp(monTab_Emp.COUNT + 1).QUANTITEKG := :NEW.QUANTITEKG;
    monTab_Emp(monTab_Emp.COUNT + 1).IDPANIER := :NEW.IDPANIER;
END AFTER EACH ROW; 

AFTER STATEMENT IS 
    newQTE CONTIENTBONBON.QUANTITEKG%TYPE;
BEGIN
    IF(INSERTING OR UPDATING) THEN
    FOR tuple IN (SELECT *
                    FROM CONTIENTBONBON
                    WHERE IDPANIER = 52)
    LOOP
        FOR i IN 1 .. monTab_Emp.COUNT LOOP 
            IF(tuple.IDB = monTab_Emp(i).IDB) THEN
                SELECT tuple.QUANTITEKG INTO newQTE
                FROM CONTIENTBONBON
                WHERE tuple.IDB = monTab_Emp(i).IDB;
            
                DELETE FROM CONTIENTBONBON
                WHERE IDB = tuple.IDB;
                
                INSERT INTO CONTIENTBONBON
                VALUES(monTab_Emp(i).IDPANIER, monTab_Emp(i).IDB ,newQTE+monTab_Emp(i).QUANTITEKG);
            END IF;
        END LOOP;
    END LOOP;
    END IF;
END AFTER STATEMENT;     
END;
/
